name: CI - Build and Push to ACR

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
      - 'frontend/**'
      - '.github/workflows/build-push.yml'

env:
  ACR_NAME: ${{ secrets.ACR_NAME }}
  IMAGE_NAME_BACKEND: burger-api
  IMAGE_NAME_FRONTEND: burger-ui
  TAG: latest

jobs:
  build_and_push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    # ----------------------------------------------------
    # Step 1: Login to Azure Container Registry (ACR)
    # نستخدم ACR Admin Credentials لتجاوز مشكلة الصلاحيات
    # ----------------------------------------------------
    - name: Log in to Azure Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.ACR_NAME }}.azurecr.io
        username: ${{ secrets.ACR_USERNAME }}
        password: ${{ secrets.ACR_PASSWORD }}
        
    # ----------------------------------------------------
    # Step 2: Build and Push Backend Image
    # نضيف --no-cache للتأكد من استخدام صورة Java 21 الجديدة
    # ----------------------------------------------------
    - name: Build and Push Backend
      run: |
        docker build -f backend/Dockerfile --no-cache \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_BACKEND }}:${{ env.TAG }} .
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_BACKEND }}:${{ env.TAG }}

    # ----------------------------------------------------
    # Step 3: Build and Push Frontend Image
    # نضيف --no-cache للتأكد من بناء صورة الواجهة الأمامية
    # ----------------------------------------------------
    - name: Build and Push Frontend
      run: |
        docker build -f frontend/Dockerfile --no-cache \
            -t ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_FRONTEND }}:${{ env.TAG }} .
        docker push ${{ env.ACR_NAME }}.azurecr.io/${{ env.IMAGE_NAME_FRONTEND }}:${{ env.TAG }}